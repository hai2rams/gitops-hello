name: Build, Push, and Bump GitOps Tag

on:
  push:
    branches: [ "main" ]
    # optional: only run when app/ changes
    # paths:
    #   - "app/**"
    #   - ".github/workflows/**"

permissions:
  contents: write
  packages: write

jobs:
  build_push_bump:
    # prevents infinite loop (when workflow commits back)
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest

    env:
      IMAGE: ghcr.io/${{ github.repository_owner }}/gitops-hello
      OVERLAY_FILE: deploy/overlays/dev/kustomization.yaml
      TAG: ${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: ./app
          push: true
          tags: |
            ${{ env.IMAGE }}:${{ env.TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Bump kustomize image tag (commit back to Git)
        run: |
          python - <<'PY'
          import re, pathlib
          p = pathlib.Path("${{ env.OVERLAY_FILE }}")
          s = p.read_text()
          # Replace the newTag line ONLY
          s2 = re.sub(r'(?m)^\s*newTag:\s*"?[0-9a-f]{7,40}"?\s*$',
                      f'    newTag: "${{ env.TAG }}"', s)
          if s2 == s:
            # fallback: replace any newTag value
            s2 = re.sub(r'(?m)^\s*newTag:\s*".*"\s*$',
                        f'    newTag: "${{ env.TAG }}"', s)
          p.write_text(s2)
          print("Updated", p)
          PY

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${{ env.OVERLAY_FILE }}"
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore(gitops): bump image tag to ${{ env.TAG }} [skip ci]"
          git push

